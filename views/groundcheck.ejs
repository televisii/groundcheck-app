<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GC Pro - Groundcheck</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #2d3436;
            --accent: #0984e3;
            --danger: #d63031;
            --bg: #fdfdfd;
            --max-width: 500px;
        }

        body {
            font-family: -apple-system, sans-serif;
            background: #e9ecef;
            margin: 0;
            display: flex;
            justify-content: center;
        }

        .main-container {
            width: 100%;
            max-width: var(--max-width);
            background: white;
            min-height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Header */
        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
        }

        .user-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        /* Stats Label */
        .stats-label {
            font-size: 11px;
            color: #636e72;
            background: #f1f2f6;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .stats-label:hover {
            background: #dfe6e9;
            border-color: #b2bec3;
            color: var(--accent);
        }

        /* Input & Validation */
        .input-minimal {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .input-error {
            border: 2px solid var(--danger) !important;
            background: #fff5f5 !important;
            animation: shake 0.3s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Card List Styles */
        .list-container {
            padding: 10px 0;
            flex-grow: 1;
            min-height: 200px;
            position: relative;
        }

        .card-item {
            padding: 16px;
            border-radius: 12px;
            margin: 10px 20px;
            background: white;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-item.pending {
            border-left: 5px solid #b2bec3;
            background: #fdfdfd;
        }

        .card-item.done {
            border-left: 5px solid #00b894;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .card-item.editable {
            border-left: 5px solid var(--accent);
            background: #f0f7ff;
        }

        .card-item b {
            font-size: 15px;
            color: var(--primary);
            padding-right: 85px;
            line-height: 1.2;
        }

        .card-item .alamat-text {
            font-size: 12px;
            color: #636e72;
            margin-top: 2px;
        }

        .card-item .idsbr-tag {
            font-size: 10px;
            color: #b2bec3;
            font-family: monospace;
            margin-top: 4px;
        }

        .petugas-info {
            font-size: 10px;
            color: #6c5ce7;
            font-style: italic;
            margin-top: 2px;
        }

        /* Badge Status */
        .badge-status {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-aktif {
            color: #00b894;
            background: #e6fffb;
        }

        .status-tidak-ditemukan {
            color: #636e72;
            background: #f1f2f6;
        }

        .status-tutup {
            color: #d63031;
            background: #fff1f0;
        }

        .status-ganda {
            color: #e17055;
            background: #fff5f0;
        }

        .status-baru {
            color: #0984e3;
            background: #ebf8ff;
        }

        /* Pagination & FAB */
        .pagination-sticky {
            position: sticky;
            bottom: 0;
            z-index: 1000;
            background: white;
            border-top: 1px solid #eee;
            padding: 12px 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
        }

        .btn-pagi {
            background: #f1f2f6;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-pagi:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .fab-add {
            position: fixed;
            bottom: 85px;
            right: 20px;
            background: var(--accent);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 24px;
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(9, 132, 227, 0.4);
        }

        @media (min-width: 500px) {
            .fab-add {
                right: calc(50% - 230px);
            }
        }

        /* Modal & Loader */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
        }

        .modal-content {
            background: white;
            width: 92%;
            max-width: 420px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 20px;
            padding: 25px;
            box-sizing: border-box;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* [MODIFIKASI CSS] Agar Header Riwayat Diam (Sticky) */
        #history-panel .modal-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Matikan scroll di container utama */
        }

        /* List Riwayat Scrollable */
        #history-list {
            flex-grow: 1;
            overflow-y: auto;
            /* Scroll hanya di area list */
            min-height: 0;
            /* Fix untuk flexbox scroll */
        }

        .swal2-container {
            z-index: 9999 !important;
        }

        #loader {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Tombol Lokasi */
        .btn-location {
            background: #00b894;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-location:hover {
            background: #019577;
        }

        .btn-location:disabled {
            background: #b2bec3;
            cursor: not-allowed;
        }

        /* Style Riwayat */
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .h-info b {
            font-size: 13px;
            color: #2d3436;
            display: block;
        }

        .h-info span {
            font-size: 11px;
            color: #636e72;
        }

        .h-time {
            font-size: 10px;
            color: #b2bec3;
            text-align: right;
            min-width: 60px;
        }

        /* Close Button Bulat */
        .btn-close-circle {
            cursor: pointer;
            font-size: 20px;
            background: #f1f2f6;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: #636e72;
            transition: 0.2s;
        }

        .btn-close-circle:hover {
            background: #dfe6e9;
            color: #2d3436;
        }

        /* Fix Leaflet Layer Control Z-Index */
        .leaflet-control-layers {
            border-radius: 8px !important;
            border: 1px solid #ddd !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1) !important;
        }

        /* Perkecil tombol layer */
        .leaflet-control-layers-toggle {
            width: 32px !important;
            height: 32px !important;
            background-size: 18px !important;
        }

        /* Tombol Lokasi Custom di Peta */
        .btn-map-custom {
            background: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 22px;
            margin-top: 5px !important;
            /* Jarak dari tombol layer */
        }

        .btn-map-custom:hover {
            background: #f1f2f6;
        }
    </style>
</head>

<body>

    <div class="main-container">
        <div class="header-sticky">
            <div class="user-row">
                <div>
                    <h2 style="margin:0; font-size:16px;">
                        <%= user.nama %>

                    </h2>
                    <div class="stats-label" onclick="showHistory()" title="Klik untuk lihat riwayat">
                        Selesai: <b id="user-count">0</b> ðŸ“œ
                    </div>

                </div>
                <a href="/logout"
                    style="font-size: 11px; color: var(--danger); text-decoration: none; font-weight: bold; border: 1px solid var(--danger); padding: 4px 10px; border-radius: 6px;">LOGOUT</a>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">

                <select id="kec" class="input-minimal" onchange="loadWilayah('kec', 'desa')">
                    <option value="">Kecamatan</option>
                </select>
                <select id="desa" class="input-minimal" onchange="onDesaChange()">
                    <option value="">Desa</option>
                </select>

            </div>
            <div id="search-area" style="display:none;"><input type="text" id="search" class="input-minimal"
                    placeholder="Cari nama usaha..." oninput="debounceSearch()"></div>
        </div>

        <div id="loader">
            <div class="spinner"></div><span style="font-size: 12px;
 color: #636e72;">Memuat data...</span>
        </div>
        <div id="list-container" class="list-container"></div>

        <div class="pagination-sticky" id="pagination-area">
            <button onclick="changePage(-1)" id="btn-prev" class="btn-pagi">Sebelumnya</button>
            <span id="page-info" style="font-size:12px;
 font-weight: bold; color: var(--primary);">Halaman 1</span>
            <button onclick="changePage(1)" id="btn-next" class="btn-pagi">Selanjutnya</button>
        </div>

    </div>

    <div id="update-panel" class="modal-overlay">
        <div class="modal-content">
            <h3 id="m-title" style="margin-top:0;
 font-size: 18px;">Update Data</h3>
            <div id="m-info-view"><b id="u-nama" style="color: var(--accent);"></b><br><span id="u-alamat" style="font-size:12px;
 color: #636e72;"></span></div>
            <div id="m-info-input" style="display:none;">
                <input type="text" id="in-nama" class="input-minimal" placeholder="Nama Usaha">
                <input type="text" id="in-alamat" class="input-minimal" placeholder="Alamat Lengkap">
            </div>

            <div id="map" style="height:225px;;
 margin: 10px 0 5px 0; border-radius:12px; border:1px solid #ddd;"></div>

            <h6 style="margin-top: 0; margin-bottom: 3px; text-align: center; font-style: italic; font-weight: normal;">
                Silahkan tekan & geser lokasi usaha, bila belum sesuai, atau input manual koordinat di bawah ini</h6>

            <div style="display:flex;
 gap:10px;">
                <input type="number" id="lat" class="input-minimal" placeholder="Lat" step="any"
                    oninput="updateMarkerFromInput()">
                <input type="number" id="lng" class="input-minimal" placeholder="Lng" step="any"
                    oninput="updateMarkerFromInput()">
            </div>

            <select id="status" class="input-minimal">
                <option value="" disabled selected>Pilih Status</option>
                <option value="Aktif">Aktif</option>
                <option value="Tidak Ditemukan">Tidak Ditemukan</option>
                <option value="Tutup">Tutup</option>
                <option value="Ganda">Ganda</option>

            </select>
            <button onclick="saveData()" style="background:var(--accent);
 color:white; border:none; padding:14px; border-radius:10px; font-weight:bold; width:100%; cursor:pointer;">SIMPAN
                DATA</button>
            <button onclick="closeModal()" class="btn-pagi" style="width:100%;
 margin-top:8px;">BATAL</button>
        </div>
    </div>

    <div id="history-panel" class="modal-overlay">
        <div class="modal-content">
            <div
                style="display:flex;
 justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div>
                    <h3 style="margin:0;
 font-size: 18px;">Riwayat Kerja</h3>
                    <small style="color:#636e72;">50 Verifikasi Terakhir</small>
                </div>
                <div onclick="document.getElementById('history-panel').style.display='none'" class="btn-close-circle">
                    &times;
                </div>

            </div>

            <div id="history-list">
                <div style="text-align:center;
 padding:20px; color:#b2bec3;">Memuat...</div>
            </div>

            <button onclick="document.getElementById('history-panel').style.display='none'" class="btn-pagi" style="width:100%;
 margin-top:15px;">TUTUP</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker, selectedIdsbr, isNewMode = false, searchTimer, currentPage = 1, totalPages = 1;
        const myEmail = "<%= user.email %>";

        document.querySelectorAll('.input-minimal').forEach(input => {
            input.addEventListener('input', () => input.classList.remove('input-error'));
            input.addEventListener('change', () => input.classList.remove('input-error'));

        });

        async function updateStats() {
            try {
                const res = await fetch('/api/stats-petugas');
                const data = await res.json();
                document.getElementById('user-count').innerText = data.total;
            } catch (e) { }
        }

        async function showHistory() {
            document.getElementById('history-panel').style.display = 'block';
            const container = document.getElementById('history-list');
            container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div></div>';

            try {
                const res = await fetch('/api/riwayat-saya');
                const data = await res.json();

                if (data.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#636e72;">Belum ada data diverifikasi.</div>';
                    return;
                }

                let html = '';
                data.forEach(item => {
                    html += `
                    <div class="history-item">
                        <div class="h-info">
                            <b>${item.nama_usaha}</b>
  
                           <span>${item.status_usaha} â€¢ ${item.alamat_usaha}</span>
                        </div>
                        <div class="h-time">${item.waktu}</div>
                    </div>
   
              `;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div style="text-align:center; color:red;">Gagal memuat riwayat.</div>';
            }
        }

        async function loadWilayah(cur, next) {
            const code = document.getElementById(cur).value;
            const res = await fetch(code ? `/api/wilayah/${code}` : `/api/wilayah`);
            const data = await res.json();
            let html = `<option value="">Pilih ${next === 'kec' ? 'Kecamatan' : 'Desa'}</option>`;
            data.forEach(d => html += `<option value="${d.kode}">${d.nama}</option>`);
            document.getElementById(next).innerHTML = html;
        }

        function onDesaChange() {
            const val = document.getElementById('desa').value;
            document.getElementById('search-area').style.display = val ? 'block' : 'none';
            // LOGIC TOMBOL FAB DIHAPUS DARI SINI
            if (val) {
                currentPage = 1;
                loadUsaha();
            }
        }

        function debounceSearch() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => { currentPage = 1; loadUsaha(); }, 500);
        }

        async function loadUsaha() {
            const desa = document.getElementById('desa').value;
            const q = document.getElementById('search').value;
            const list = document.getElementById('list-container');
            const loader = document.getElementById('loader');

            list.style.display = 'none';
            loader.style.display = 'block';
            try {
                const res = await fetch(`/api/usaha-pending/${desa}?search=${q}&page=${currentPage}`);
                const result = await res.json();

                totalPages = result.totalPages || 1;
                document.getElementById('pagination-area').style.display = totalPages > 0 ? 'flex' : 'none';
                document.getElementById('page-info').innerText = `Halaman ${currentPage} dari ${totalPages}`;
                document.getElementById('btn-prev').disabled = (currentPage <= 1);
                document.getElementById('btn-next').disabled = (currentPage >= totalPages);

                list.innerHTML = '';
                result.data.forEach(u => {
                    const div = document.createElement('div');
                    const isMine = u.petugas_email === myEmail;
                    div.className = `card-item ${u.is_verified ? (isMine ? 'done editable' : 'done') : 'pending'}`;


                    const statusClass = u.status_usaha ? 'status-' + u.status_usaha.toLowerCase().replace(/\s/g, '-') : '';
                    const badge = u.is_verified ? `<div class="badge-status ${statusClass}">${u.status_usaha}</div>` : `<div class="badge-status" style="color:#636e72; background:#f1f2f6;">BELUM GC</div>`;

                    div.innerHTML = `
                    ${badge}
             
        <b>${u.nama_usaha}</b>
                    <span class="alamat-text">${u.alamat_usaha || '-'}</span>
                    <span class="idsbr-tag">ID: ${u.idsbr}</span>
                    ${u.is_verified ? `<span class="petugas-info">Oleh: ${u.petugas_email}</span>` : ''}
                `;


                    div.onclick = () => {
                        if (u.is_verified && !isMine) Swal.fire({ title: 'Terkunci', text: 'Data milik petugas lain.', icon: 'info' });
                        else openModal(u, false);
                    };
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:red;">Gagal memuat data</div>`;
            } finally {
                loader.style.display = 'none';
                list.style.display = 'block';
            }
        }

        function changePage(dir) {
            if ((dir === -1 && currentPage > 1) || (dir === 1 && currentPage < totalPages)) {
                currentPage += dir;
                loadUsaha(); window.scrollTo(0, 0);
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                const btn = document.getElementById('btn-locate');

                if (btn) {
                    btn.innerHTML = '<div class="spinner" style="width:12px;height:12px;border-width:2px;margin:0"></div>';
                    btn.disabled = true;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        setMarker(lat, lng);

                        if (btn) {
                            btn.innerHTML = 'âŒ–';
                            btn.disabled = false;
                        }
                        Swal.fire({ icon: 'success', title: 'Lokasi GPS diambil', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });

                    },
                    (error) => {
                        if (btn) {
                            btn.innerHTML = 'âŒ–';
                            btn.disabled = false;
                        }

                        setMarker(-6.17, 106.82);
                        let msg = 'Gagal mengambil lokasi.';
                        if (error.code == 1) msg = 'GPS Ditolak. Izinkan akses lokasi di browser.';
                        else
                            if (error.code == 2) msg = 'Sinyal GPS lemah.';
                        Swal.fire('GPS Error', msg, 'error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                setMarker(-6.17, 106.82);
                Swal.fire('Error', 'Browser tidak mendukung Geolocation.', 'error');
            }
        }

        function openModal(u, isNew) {
            isNewMode = isNew;
            selectedIdsbr = isNew ? null : u.idsbr;
            const st = document.getElementById('status');
            document.querySelectorAll('.input-minimal').forEach(el => el.classList.remove('input-error'));
            document.getElementById('update-panel').style.display = 'block';
            if (isNew) {
                document.getElementById('m-title').innerText = "Tambah Baru";
                document.getElementById('m-info-view').style.display = 'none';
                document.getElementById('m-info-input').style.display = 'block';
                st.value = "BARU"; st.disabled = true;
                document.getElementById('in-nama').value = ""; document.getElementById('in-alamat').value = "";
            } else {
                document.getElementById('m-title').innerText = "Update Usaha";
                document.getElementById('m-info-view').style.display = 'block';
                document.getElementById('m-info-input').style.display = 'none';
                document.getElementById('u-nama').innerText = u.nama_usaha;
                document.getElementById('u-alamat').innerText = u.alamat_usaha;
                st.value = u.status_usaha || "";
                st.disabled = (u.status_usaha === "BARU");
            }

            if (!map) {
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
                const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',
                    { maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });
                map = L.map('map', { zoomControl: false, layers: [googleHybrid] }).setView([0, 0], 13);

                // --- [LOGIKA KLIK PETA PINDAH MARKER] ---
                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        setMarker(lat, lng);
                    }

                    // Update input form lat/lng
                    document.getElementById('lat').value = lat.toFixed(7);
                    document.getElementById('lng').value = lng.toFixed(7);
                });
                // ----------------------------------------

                const baseMaps = { "Satelit": googleHybrid, "Peta": osmLayer };
                L.control.layers(baseMaps).addTo(map);

                // Tambah Tombol Lokasi Custom di Bawah Layer
                const LocControl = L.Control.extend({
                    options: { position: 'topright' },
                    onAdd: function () {
                        const btn
                            = L.DomUtil.create('button', 'btn-map-custom');
                        btn.id = 'btn-locate';
                        btn.type = 'button';
                        btn.innerHTML = 'âŒ–';

                        btn.onclick = (e) => { L.DomEvent.stopPropagation(e); getCurrentLocation(); };
                        return btn;
                    }
                });
                map.addControl(new LocControl());
            }

            setTimeout(() => { map.invalidateSize(); }, 100);
            const lat = (!isNew && u.latitude) ? parseFloat(u.latitude) : null;
            const lng = (!isNew && u.longitude) ? parseFloat(u.longitude) : null;
            if (lat && lng) {
                setMarker(lat, lng);
            } else {
                getCurrentLocation();
            }
        }

        // [FITUR BARU] Update Marker dari Input Manual
        function updateMarkerFromInput() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            if (!isNaN(lat) && !isNaN(lng)) {
                if (marker) {
                    const newLatLng = new L.LatLng(lat, lng);
                    marker.setLatLng(newLatLng);
                    map.panTo(newLatLng); // Geser peta ke marker
                } else {
                    setMarker(lat, lng);
                }
            }
        }

        function setMarker(lat, lng) {
            document.getElementById('lat').value = lat.toFixed(7);
            document.getElementById('lng').value = lng.toFixed(7);
            if (!marker) {
                marker = L.marker([lat, lng], {
                    draggable: true,
                    title: "Silahkan tekan & geser lokasi usaha, bila belum sesuai"
                }).addTo(map).bindTooltip("Lokasi Usaha", { permanent: true, direction: 'top', offset: [-13, -5] });
                marker.on('dragend', () => { const p = marker.getLatLng(); document.getElementById('lat').value = p.lat.toFixed(7); document.getElementById('lng').value = p.lng.toFixed(7); });
            } else marker.setLatLng([lat, lng]);
            map.setView([lat, lng], 17);
        }

        async function saveData() {
            const s = document.getElementById('status'), lt = document.getElementById('lat'), ln = document.getElementById('lng'), n = document.getElementById('in-nama'), a = document.getElementById('in-alamat');
            let valid = true;

            if (!s.value) {
                s.classList.add('input-error'); valid = false;
            }
            if (!lt.value) {
                lt.classList.add('input-error'); valid = false;
            }
            if (!ln.value) {
                ln.classList.add('input-error'); valid = false;
            }
            if (isNewMode) {
                if (!n.value) {
                    n.classList.add('input-error');
                    valid = false;
                }
                if (!a.value) {
                    a.classList.add('input-error');
                    valid = false;
                }
            }

            if (!valid) return Swal.fire('Error', 'Lengkapi kolom merah!', 'warning');
            Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const body = {
                idsbr: selectedIdsbr,
                lat: lt.value,
                lng: ln.value,
                status_usaha: s.value,
                petugas: "<%= user.nama %>",

                petugas_email: myEmail,
                is_new: isNewMode,
                kode_desa: document.getElementById('desa').value,
                nama_usaha: isNewMode ?
                    n.value : null,
                alamat_usaha: isNewMode ?
                    a.value : null
            };
            try {
                const res = await fetch('/api/verifikasi', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const result = await res.json();
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Berhasil', timer: 1000, showConfirmButton: false });
                    closeModal(); loadUsaha(); updateStats();
                } else {
                    Swal.fire('Gagal', result.message, 'error');
                    if (res.status === 403) { closeModal(); loadUsaha(); }
                }
            } catch (e) {
                Swal.fire('Error', 'Masalah Jaringan', 'error');
            }
        }

        function closeModal() {
            document.getElementById('update-panel').style.display = 'none';
        }
        window.onload = () => { loadWilayah('kec', 'kec'); updateStats(); };
    </script>
</body>

</html>