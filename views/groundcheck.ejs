<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GC Pro - Groundcheck</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #2d3436; --accent: #0984e3; --danger: #d63031; --bg: #fdfdfd; --max-width: 500px; }
        body { font-family: -apple-system, sans-serif; background: #e9ecef; margin: 0; display: flex; justify-content: center; }
        
        .main-container { width: 100%; max-width: var(--max-width); background: white; min-height: 100vh; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Sticky Header */
        .header-sticky { position: sticky; top: 0; z-index: 1000; background: white; border-bottom: 1px solid #eee; padding: 15px 20px; }
        .user-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .stats-label { font-size: 11px; color: #636e72; background: #f1f2f6; padding: 4px 10px; border-radius: 20px; }

        /* Sticky Pagination Bottom */
        .pagination-sticky { position: sticky; bottom: 0; z-index: 1000; background: white; border-top: 1px solid #eee; padding: 10px 20px; display: none; justify-content: space-between; align-items: center; }

        .input-minimal { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; outline: none; transition: 0.3s; }
        .input-error { border: 2px solid var(--danger) !important; background: #fff5f5 !important; }

        /* List Style */
        .list-container { padding: 10px 0; flex-grow: 1; }
        .card-item { padding: 16px; border-radius: 12px; margin: 10px 20px; border: 1px solid #eee; cursor: pointer; position: relative; overflow: hidden; }
        .card-item.done { background: #f9f9f9; border-left: 5px solid #00b894; }
        .card-item.editable { border-left: 5px solid var(--accent); background: #f0f7ff; }
        
        .card-item b { display: block; font-size: 14px; color: var(--primary); margin-bottom: 4px; padding-right: 60px; }
        .card-item span { font-size: 12px; color: #636e72; display: flex; align-items: center; }
        .petugas-info { font-size: 10px; color: #6c5ce7; font-style: italic; margin-top: 5px; display: block; }
        
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-pending { background: #fdcb6e; }
        .dot-done { background: #00b894; }
        
        .badge-status { position: absolute; top: 12px; right: 12px; font-size: 9px; padding: 3px 8px; border-radius: 5px; font-weight: bold; text-transform: uppercase; }
        .status-aktif { color: #00b894; background: #e6fffb; }
        .status-tutup { color: var(--danger); background: #fff1f0; }

        /* PERBAIKAN FAB: Selalu di dalam container utama */
        .fab-add { 
            position: fixed; 
            bottom: 80px; 
            /* Menghitung posisi agar FAB tetap di dalam max-width 500px */
            left: calc(50% + (var(--max-width) / 2) - 76px); 
            background: var(--accent); 
            color: white; 
            border: none; 
            width: 56px; 
            height: 56px; 
            border-radius: 50%; 
            font-size: 24px; 
            cursor: pointer; 
            z-index: 1500; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 12px rgba(9,132,227,0.4); 
        }

        /* FAB untuk layar Mobile asli */
        @media (max-width: 500px) {
            .fab-add { left: auto; right: 20px; }
        }

        /* Modal Center */
        #update-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; }
        .modal-content { background: white; width: 92%; max-width: 420px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 20px; padding: 25px; box-sizing: border-box; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #f1f2f6; color: #636e72; border: 1px solid #ddd; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }

        .swal2-container { z-index: 9999 !important; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header-sticky">
        <div class="user-row">
            <div>
                <h2 style="margin:0; font-size:16px;"><%= user.nama %></h2>
                <div class="stats-label">GC Saya: <b id="user-count">0</b></div>
            </div>
            <a href="/logout" style="font-size: 12px; color: var(--danger); text-decoration: none; font-weight: bold;">LOGOUT</a>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <select id="kec" class="input-minimal" onchange="loadWilayah('kec', 'desa')"><option value="">Kecamatan</option></select>
            <select id="desa" class="input-minimal" onchange="onDesaChange()"><option value="">Desa</option></select>
        </div>
        <div id="search-area" style="display:none; margin-top:10px;">
            <input type="text" id="search" class="input-minimal" placeholder="Cari nama usaha..." oninput="debounceSearch()">
        </div>
    </div>

    <div id="list-container" class="list-container">
        <div style="text-align: center; color: #b2bec3; margin-top: 60px;">Pilih wilayah kerja</div>
    </div>

    <div class="pagination-sticky" id="pagination-area">
        <button onclick="changePage(-1)" id="btn-prev" class="btn-cancel" style="padding: 8px 15px;">Prev</button>
        <span id="page-info" style="font-size:13px; font-weight: bold;">Hal 1</span>
        <button onclick="changePage(1)" id="btn-next" class="btn-cancel" style="padding: 8px 15px;">Next</button>
    </div>

    <button class="fab-add" id="fab-tambah" onclick="openModal(null, true)">+</button>
</div>

<div id="update-panel">
    <div class="modal-content">
        <h3 id="m-title" style="margin-top:0; font-size: 18px;">Verifikasi Data</h3>
        <div id="m-info-view"><b id="u-nama" style="color: var(--accent);"></b><br><span id="u-alamat" style="font-size:12px; color: #636e72;"></span></div>
        <div id="m-info-input" style="display:none;">
            <input type="text" id="in-nama" class="input-minimal" placeholder="Nama Usaha" style="margin-bottom:10px;">
            <input type="text" id="in-alamat" class="input-minimal" placeholder="Alamat Lengkap">
        </div>
        <div id="map" style="height:170px; margin:15px 0; border-radius:12px; border:1px solid #ddd;"></div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="lat" class="input-minimal" placeholder="Lat" step="any">
            <input type="number" id="lng" class="input-minimal" placeholder="Lng" step="any">
        </div>
        <select id="status" class="input-minimal" style="margin-top:10px;">
            <option value="" disabled selected>Pilih Status Usaha</option>
            <option value="Aktif">Aktif</option>
            <option value="Tutup">Tutup / Tidak Ditemukan</option>
            <option value="Pindah">Pindah Alamat</option>
        </select>
        <div class="btn-group">
            <button onclick="saveData()" class="btn-save">SIMPAN & KUNCI DATA</button>
            <button onclick="closeModal()" class="btn-cancel">BATAL / KEMBALI</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map, marker, selectedIdsbr, isNewMode = false, searchTimer, currentPage = 1, totalPages = 1;
    const myEmail = "<%= user.email %>";

    async function updateStats() {
        const res = await fetch('/api/stats-petugas');
        const data = await res.json();
        document.getElementById('user-count').innerText = data.total;
    }

    async function loadWilayah(cur, next) {
        const code = document.getElementById(cur).value;
        const res = await fetch(code ? `/api/wilayah/${code}` : `/api/wilayah`);
        const data = await res.json();
        let html = `<option value="">Pilih ${next === 'kec' ? 'Kecamatan' : 'Desa'}</option>`;
        data.forEach(d => html += `<option value="${d.kode}">${d.nama}</option>`);
        document.getElementById(next).innerHTML = html;
    }

    function onDesaChange() {
        const val = document.getElementById('desa').value;
        document.getElementById('search-area').style.display = val ? 'block' : 'none';
        document.getElementById('fab-tambah').style.display = val ? 'flex' : 'none';
        if(val) { currentPage = 1; loadUsaha(); }
    }

    function debounceSearch() { 
        clearTimeout(searchTimer); 
        searchTimer = setTimeout(() => { currentPage = 1; loadUsaha(); }, 500); 
    }

    async function loadUsaha() {
        const desa = document.getElementById('desa').value;
        const q = document.getElementById('search').value;
        const res = await fetch(`/api/usaha-pending/${desa}?search=${q}&page=${currentPage}`);
        const result = await res.json();
        
        totalPages = result.totalPages;
        document.getElementById('pagination-area').style.display = totalPages > 0 ? 'flex' : 'none';
        document.getElementById('page-info').innerText = `Hal ${currentPage} dari ${totalPages}`;
        document.getElementById('btn-prev').disabled = currentPage === 1;
        document.getElementById('btn-next').disabled = currentPage === totalPages || totalPages === 0;

        const container = document.getElementById('list-container');
        container.innerHTML = '';
        
        result.data.forEach(u => {
            const div = document.createElement('div');
            const isMine = u.petugas_email === myEmail;
            div.className = `card-item ${u.is_verified ? 'done' : ''} ${u.is_verified && isMine ? 'editable' : ''}`;
            
            let badge = u.is_verified ? `<div class="badge-status ${u.status_usaha === 'Aktif' ? 'status-aktif' : 'status-tutup'}">${u.status_usaha}</div>` : '';
            let emailTag = u.is_verified ? `<span class="petugas-info">Oleh: ${u.petugas_email}</span>` : '';

            div.innerHTML = `${badge}<b>${u.nama_usaha}</b><span><div class="dot ${u.is_verified ? 'dot-done' : 'dot-pending'}"></div> ${u.alamat_usaha || '-'}</span>${emailTag}`;
            div.onclick = () => { if(u.is_verified && !isMine) Swal.fire('Terkunci', 'Petugas lain sudah mengisi.', 'info'); else openModal(u, false); };
            container.appendChild(div);
        });
    }

    function changePage(dir) { currentPage += dir; loadUsaha(); window.scrollTo(0,0); }

    function openModal(u, isNew) {
        isNewMode = isNew;
        selectedIdsbr = isNew ? null : u.idsbr;
        document.querySelectorAll('.input-minimal').forEach(el => el.classList.remove('input-error'));
        document.getElementById('update-panel').style.display = 'block';
        document.getElementById('m-title').innerText = isNew ? "Tambah Usaha Baru" : "Verifikasi Data";
        document.getElementById('m-info-view').style.display = isNew ? 'none' : 'block';
        document.getElementById('m-info-input').style.display = isNew ? 'block' : 'none';
        
        if(!isNew) {
            document.getElementById('u-nama').innerText = u.nama_usaha;
            document.getElementById('u-alamat').innerText = u.alamat_usaha;
            document.getElementById('status').value = u.status_usaha || "";
        }

        if (!map) {
            map = L.map('map', { zoomControl: false }).setView([0,0], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        const lat = (!isNew && u.latitude) ? parseFloat(u.latitude) : null;
        const lng = (!isNew && u.longitude) ? parseFloat(u.longitude) : null;
        if(lat && lng) setMarker(lat, lng);
        else navigator.geolocation.getCurrentPosition(pos => setMarker(pos.coords.latitude, pos.coords.longitude), () => setMarker(-6.17, 106.82));
    }

    function setMarker(lat, lng) {
        document.getElementById('lat').value = lat.toFixed(7);
        document.getElementById('lng').value = lng.toFixed(7);
        if(!marker) {
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);
            marker.on('dragend', () => {
                const p = marker.getLatLng();
                document.getElementById('lat').value = p.lat.toFixed(7);
                document.getElementById('lng').value = p.lng.toFixed(7);
            });
        } else marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 17);
    }

    async function saveData() {
        const s = document.getElementById('status'), lt = document.getElementById('lat'), ln = document.getElementById('lng'), n = document.getElementById('in-nama');
        let v = true;
        [s, lt, ln].forEach(el => { if(!el.value) { el.classList.add('input-error'); v = false; }});
        if(isNewMode && !n.value) { n.classList.add('input-error'); v = false; }
        if(!v) return Swal.fire('Gagal', 'Lengkapi kolom merah!', 'warning');

        const body = { idsbr: selectedIdsbr, lat: lt.value, lng: ln.value, status_usaha: s.value, petugas: "<%= user.nama %>", petugas_email: myEmail, is_new: isNewMode, kode_desa: document.getElementById('desa').value, nama_usaha: isNewMode ? n.value : null, alamat_usaha: isNewMode ? document.getElementById('in-alamat').value : null };
        const res = await fetch('/api/verifikasi', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        if(res.ok) { Swal.fire({ icon: 'success', title: 'Tersimpan', showConfirmButton: false, timer: 1500 }); closeModal(); loadUsaha(); updateStats(); }
    }

    function closeModal() { document.getElementById('update-panel').style.display = 'none'; }
    window.onload = () => { loadWilayah('kec', 'kec'); updateStats(); };
</script>
</body>
</html>